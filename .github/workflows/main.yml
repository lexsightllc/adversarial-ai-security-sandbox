# SPDX-License-Identifier: MPL-2.0

name: CI/CD Pipeline - Build, Test, Scan & Deploy

on:
  push:
    branches:
      - main
      - develop
  pull_request:
    branches:
      - main
      - develop

env:
  DOCKER_REGISTRY: docker.io
  DOCKER_USERNAME: "${{ secrets.DOCKER_USERNAME }}"
  DOCKER_PASSWORD: "${{ secrets.DOCKER_PASSWORD }}"
  IMAGE_REPO_PREFIX: ai-adversarial-sandbox-pro

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        service: [api-gateway, model-service, attack-service, frontend]
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Login to DockerHub (or other registry)
      if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop' # Only login on push to main/develop
      uses: docker/login-action@v3
      with:
        username: "${{ env.DOCKER_USERNAME }}"
        password: "${{ env.DOCKER_PASSWORD }}"
        registry: "${{ env.DOCKER_REGISTRY }}"

    - name: Build Docker image for ${{ matrix.service }}
      id: build-image # Add an ID to reference outputs
      run: |
        SERVICE_PATH="./services/${{ matrix.service }}"
        DOCKERFILE_PATH="$SERVICE_PATH/Dockerfile"
        IMAGE_TAG="${{ env.DOCKER_REGISTRY }}/${{ env.IMAGE_REPO_PREFIX }}-${{ matrix.service }}:latest"

        if [ "${{ matrix.service }}" == "frontend" ]; then
          SERVICE_PATH="./frontend"
          DOCKERFILE_PATH="$SERVICE_PATH/Dockerfile.dev" # Using dev Dockerfile for simplicity for now
          IMAGE_TAG="${{ env.DOCKER_REGISTRY }}/${{ env.IMAGE_REPO_PREFIX }}-${{ matrix.service }}:latest-dev"
        fi

        docker build -t $IMAGE_TAG -f $DOCKERFILE_PATH $SERVICE_PATH
        echo "::set-output name=image_tag::$IMAGE_TAG" # Output the built image tag

        # Push only if it's a main or develop branch build (not on PR check run)
        if [ "${{ github.ref }}" == "refs/heads/main" ] || [ "${{ github.ref }}" == "refs/heads/develop" ]; then
          echo "Pushing $IMAGE_TAG"
          docker push $IMAGE_TAG
        else
          echo "Skipping push for PR/other branch build."
        fi

    - name: Run SAST with Bandit (Python services only)
      if: contains(fromJSON('["api-gateway", "model-service", "attack-service"]'), matrix.service)
      run: |
        pip install bandit[toml]
        bandit -r services/${{ matrix.service }} -f json -o bandit-report.json || true
        bandit -r services/${{ matrix.service }} -f txt
        # Check for high severity issues
        if python -m json.tool bandit-report.json | grep -q '"severity": "HIGH"'; then
          echo "WARNING: High severity security issues found by Bandit"
        fi
      continue-on-error: true

    - name: Upload Bandit Report
      if: contains(fromJSON('["api-gateway", "model-service", "attack-service"]'), matrix.service)
      uses: actions/upload-artifact@v4
      with:
        name: bandit-report-${{ matrix.service }}
        path: bandit-report.json
      continue-on-error: true

    - name: Scan Docker Image for Vulnerabilities with Trivy
      uses: aquasecurity/trivy-action@master
      with:
        image-ref: "${{ steps.build-image.outputs.image_tag }}"
        format: 'sarif'
        output: 'trivy-results.sarif'
        severity: 'CRITICAL,HIGH'
        ignore-unfixed: true
        vuln-type: 'os,library'

    - name: Upload Trivy Results to GitHub Security
      uses: github/codeql-action/upload-sarif@v3
      if: always()
      with:
        sarif_file: 'trivy-results.sarif'
        category: 'trivy-${{ matrix.service }}'

    - name: Check Trivy Results
      run: |
        trivy image --severity CRITICAL,HIGH --exit-code 0 "${{ steps.build-image.outputs.image_tag }}" || true
      continue-on-error: true

    - name: Run unit/integration tests for ${{ matrix.service }}
      run: |
        if [ "${{ matrix.service }}" != "frontend" ]; then
          echo "Running backend tests for ${{ matrix.service }}..."
          pip install -q pytest pytest-cov pytest-asyncio
          cd /home/user/adversarial-ai-security-sandbox
          # Install all service dependencies
          for service in api-gateway model-service attack-service; do
            pip install -q -r services/$service/requirements.txt || true
          done
          # Run tests with coverage
          pytest tests/test_${{ matrix.service }}.py --cov=services --cov-report=xml --cov-report=term -v || true
        else
          echo "Running frontend tests for ${{ matrix.service }}..."
          cd /home/user/adversarial-ai-security-sandbox/frontend
          npm install --legacy-peer-deps --quiet
          npm run test:ci || true
        fi

    - name: Upload coverage reports
      uses: codecov/codecov-action@v3
      if: always()
      with:
        files: ./coverage.xml
        flags: ${{ matrix.service }}
        fail_ci_if_error: false

  license-compliance:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Install REUSE tooling
      run: |
        python -m pip install --upgrade pip
        pip install reuse

    - name: Verify SPDX headers with REUSE
      run: reuse lint

    - name: Install ScanCode Toolkit
      run: |
        python -m pip install scancode-toolkit

    - name: Run ScanCode license scan
      run: |
        scancode --license --summary-verbose --json scancode-report.json .

    - name: Upload ScanCode report
      uses: actions/upload-artifact@v4
      with:
        name: scancode-license-report
        path: scancode-report.json

  deploy:
    needs: [build-and-test, license-compliance] # Depends on successful build/tests and license compliance
    runs-on: ubuntu-latest
    environment: 
      name: development # Example environment, could be staging, production
      url: https://dev.adversarial-sandbox.com # Placeholder URL
    if: github.ref == 'refs/heads/develop' || github.ref == 'refs/heads/main' # Only deploy main/develop branches
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Configure Cloud Provider CLI (e.g., AWS EKS, GCP GKE, Azure AKS)
      run: |
        echo "Configuring cloud provider CLI for deployment..."
        echo "Authentication with cloud provider secrets goes here."

    - name: Deploy to Kubernetes Cluster (Conceptual)
      run: |
        echo "Deploying applications to Kubernetes cluster in ${{ github.ref_name }} environment..."
        echo "Deployment script for ${{ github.ref_name }} environment would execute here."
        echo "Images pushed: "
        echo "- ${{ env.DOCKER_REGISTRY }}/${{ env.IMAGE_REPO_PREFIX }}-api-gateway:latest"
        echo "- ${{ env.DOCKER_REGISTRY }}/${{ env.IMAGE_REPO_PREFIX }}-model-service:latest"
        echo "- ${{ env.DOCKER_REGISTRY }}/${{ env.IMAGE_REPO_PREFIX }}-attack-service:latest"
        echo "- ${{ env.DOCKER_REGISTRY }}/${{ env.IMAGE_REPO_PREFIX }}-frontend:latest-dev"
        echo "Deployment to ${{ github.ref_name }} completed (conceptually)."
